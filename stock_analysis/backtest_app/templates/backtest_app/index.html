{% extends 'base/base.html' %}

{% block body %}
<h1>バックテストを実行</h1>

{% if form.errors %}
    <div style="color: red;">
        <h3>フォームエラー:</h3>
        <ul>
            {% for field, errors in form.errors.items %}
                <li>{{ field }}: {{ errors|join:", " }}</li>
            {% endfor %}
        </ul>
    </div>
{% endif %}

<!-- 一括チェックボタン -->
<div>
    <button type="button" onclick="toggleCheckboxes(true)">すべて選択</button>
    <button type="button" onclick="toggleCheckboxes(false)">すべて解除</button>
</div>

<form method="post">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">実行</button>
</form>

<form method="post" action="{% url 'update_stock_data' %}">
    {% csrf_token %}
    <button type="submit">最新データを更新</button>
</form>

{% if result_data %}
    {% if result_data.error %}
        <p style="color: red;">エラー: {{ result_data.error }}</p>
    {% else %}
        <h2>バックテスト結果</h2>
        <p>最も利益が出た銘柄: {{ result_data.best_ticker }}</p>
        <p>最も利益が出た銘柄のリターン: {{ result_data.best_return }}%</p>
        <p>直近2日間で買いフラグが出た銘柄: {{ result_data.buy_signal_tickers|join:", " }}</p>
        <p>直近2日間で売りフラグが出た銘柄: {{ result_data.sell_signal_tickers|join:", " }}</p>
        <p>各銘柄の平均リターン: {{ result_data.average_return }}%</p>
        <p>各銘柄の平均取引回数: {{ result_data.average_trades }}</p>
    {% endif %}
{% endif %}

{% if graph_html %}
    <h2>グラフ</h2>
    <div>{{ graph_html|safe }}</div>
{% else %}
    <p>グラフがありません。</p>
{% endif %}

<script>
    // すべてのチェックボックスを選択または解除する関数
    function toggleCheckboxes(checked) {
        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = checked;
        });
    }
</script>
{% endblock %}